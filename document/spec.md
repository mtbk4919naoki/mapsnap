# 仕様書

## 概要

WebサイトのURLを指定すると、サイトマップの取得または生成を行い、それを元にスクリーンショットを保存していくアプリケーション

## 詳細仕様

### ディレクトリ構成

- 出力先: `./dist/`
  - `./dist/sitemap.xml` - 生成されたサイトマップ
  - `./dist/screenshot/` - スクリーンショット保存先

### UI

CLIでの操作を基本とし、npm-scriptで実行する。

#### コマンド0: start（対話式実行）
```bash
npm run start
```

一連の作業を対話式で実行します。各コマンドを順番に実行し、オプション設定も対話式で入力できます。

**処理内容:**
1. セットアップの自動実行
2. サイトマップの生成・取得
   - サイトのURLを入力
   - 既存のsitemap.xmlのURLを入力（空欄の場合は自動生成）
3. スクリーンショットの取得（オプション設定可能）
   - 階層の深さ（既定: 0=無制限）
   - 各階層での取得上限（既定: 9）
   - 全体の取得上限（既定: 100）
   - エラー時の自動続行（既定: n）
   - PNG画像の圧縮（既定: y）
4. zipファイルの作成（選択可）

**注意:**
- `start`コマンドでは、sitemap.xmlのパスは自動的に`./dist/sitemap.xml`を使用します

#### コマンド1: setup
```bash
npm run setup
```

一連の作業を実施する前に必要な準備や初期化を行います。

**処理内容:**
- `./dist/` ディレクトリの作成（存在しない場合）
- `./dist/screenshot/` ディレクトリの作成（存在しない場合）
- `./output/` ディレクトリの作成（存在しない場合）
- 既存の出力ファイルのクリーンアップ（`./dist/` 内の既存ファイルを削除）
- `.env` などの設定ファイルが必要な場合、対話式で入力を受け付ける

#### コマンド2: gen-sitemap
```bash
npm run gen-sitemap "https://example.com"
```

指定されたURLのサイトマップを取得または生成します。

**引数:**
- URL: 引用符で囲んで指定（例: `"https://example.com"`）

**オプション:**

`-m, --map "https://example.com/sitemap.xml"`  
- このオプションが有効だと指定されたsitemap.xml（またはsitemap index）を解析して使用する
- 複数のsitemapファイルに分割されている場合（sitemap index形式）、それらを1つのsitemap.xmlに統合する
- リモートのsitemapファイルは一時的にダウンロードして解析し、統合後のsitemap.xmlを `./dist/sitemap.xml` に保存する
- このオプションが指定されていない場合は、`sitemap-generator` パッケージを使用してサイトマップを生成する

**出力:**
- `./dist/sitemap.xml` にサイトマップを保存
- 生成後、階層順に自動ソート（0階層 → 1階層 → 2階層...）

**進捗表示:**
- 現在実行中の処理を表示（例: "サイトマップを生成中...", "sitemap.xmlを解析中...", "サイトマップを階層順にソート中..."）

#### コマンド3: get-screenshot
```bash
npm run get-screenshot ["./dist/sitemap.xml"]
```

指定されたサイトマップを元にスクリーンショットを `./dist/screenshot/` 内に保存します。

**引数:**
- sitemap.xmlのパス（省略された場合は `./dist/sitemap.xml` を既定とする）

**ファイル名規則:**
- 取得順に `pageID（Increment 4digit zero-fill）_urlPath（/を__に置換、末尾の/は削除）.png` とする
- 例: `0001_index.png`, `0002_about__contact.png`, `0003_hoge__foo.png`

**スクリーンショット設定:**
- ビューポートサイズ: 1920x1080
- ページ読み込み待機: `networkidle0` まで待機
- スクロール処理: ページをゆっくり一番下までスクロール（100ms間隔、100pxずつ）
- アニメーション待機: スクロール前後に各1秒待機
- 撮影方法: ページ全体（`fullPage: true`）

**オプション:**

`-d, --depth "0"`  
- 階層の深さを指定する
- `0` で無制限（既定値）
- 数値で指定した場合、その階層未満（指定した階層より小さい階層）を処理する
- 階層の数え方: URLパスのスラッシュ数で判定（例: `https://example.com/page1/page2` は階層2）
- 例: `-d 2` で階層0と1を取得、`-d 1` で階層0（ルート）のみを取得

`-r, --repeat "9"`  
- 各階層と親パスの組み合わせで何ページまで連続でスクリーンショットを撮るか指定する
- `0` で無制限、`1` だと1枚、既定は `9`
- 各階層と親パスの組み合わせごとに上限をリセットする
- 階層が異なる場合は別扱いになる（例: `hoge/foo`, `hoge/bar` と `fuga/foo`, `fuga/bar` は別グループとして扱われる）
- 例: `-r 2` を指定した場合、`hoge/foo`, `hoge/bar` の2枚で上限に達し、次に `fuga/foo`, `fuga/bar` も別グループとして2枚取得できる

`-l, --limit "100"`  
- 全体のスクリーンショット取得上限を指定する
- 既定は `100`
- 上限値に達した場合はメッセージを表示して終了する

`-y, --yes`  
- 2xx系以外のHTTPレスポンスが発生した場合、確認ダイアログをスキップして全て続行する
- このオプションがない場合、2xx以外のレスポンスでは続行確認ダイアログを表示する

`-c, --compress`  
- PNG画像を圧縮する
- `sharp`ライブラリを使用してPNGを圧縮し、ファイルサイズを削減する
- 圧縮率: quality 80, compressionLevel 9
- ファイルサイズを大幅に削減できるが、処理時間が若干増加する

**進捗表示:**
- 現在実行中の処理を表示
- スクリーンショット取得時は「Nページ中のMページ目」を表示（例: "スクリーンショット取得中: 10ページ中の3ページ目"）

**エラーハンドリング:**
- エラー発生時はエラーメッセージを表示して終了
- 2xx系以外のHTTPレスポンスが発生した場合:
  - `-y` オプションがない場合: 続行確認ダイアログを表示
  - `-y` オプションがある場合: 自動的に続行

#### コマンド4: zip
```bash
npm run zip
```

コマンド2,3で得たサイトマップとスクリーンショットをzipファイルにします。

**処理内容:**
- `gen-sitemap` コマンドで指定したURLからドメイン名を抽出
- `./dist/` 内の全ファイル（`sitemap.xml` と `screenshot/` 内の全ファイル）をzip化（`.config.json`は除外）
- ファイル名: `{ドメイン名}_generated_{タイムスタンプ}.zip`
- タイムスタンプ形式: `YYYYMMDD_HHMMSS`
- 保存先: `./output/` ディレクトリ（自動作成）

**例:**
- URL: `https://example.com` → `./output/example.com_generated_20241220_143025.zip`
- URL: `https://www.example.com` → `./output/www.example.com_generated_20241220_143025.zip`

**進捗表示:**
- 現在実行中の処理を表示（例: "zipファイルを作成中..."）

## 技術仕様

### 使用パッケージ
- `puppeteer`: スクリーンショット取得
- `sitemap-generator`: サイトマップ生成
- `commander`: CLI引数解析
- `xml2js`: XML解析
- `archiver`: zipファイル作成

### 既存ファイル
- `sitemap.js` → `sitemap.js.example` にリネーム（参考実装として保持）
- `screenshot.js` → `screenshot.js.example` にリネーム（参考実装として保持）
